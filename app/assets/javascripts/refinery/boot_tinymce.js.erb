$(document).on('ready page:load', function(){

  tinymce.init({
    selector: "textarea.visual_editor",
    menubar : false,
    plugins: ["image", "link"],

    file_browser_callback   : function(field_name, url, type, win) {

        if (type == 'image') {
          var title_text = "Choose an Image"
          var cmsURL       = '/refinery/dialogs/image';
        } else {
          var title_text = "Choose Object to Link"
          var cmsURL       = '/refinery/dialogs/link';
        }

        tinymce.activeEditor.windowManager.open({
          file            : cmsURL,
          title           : title_text,
          width           : 600,  // Your dimensions may differ - toy around with them!
          height          : 600,
          resizable       : "yes",
          inline          : "yes",  // This parameter only has an effect if you use the inlinepopups plugin!
          close_previous  : "yes"
        }, {
          window  : win,
          input   : field_name
        });
      }
  });

  $('#submit_button').on('click', function(event){
    var args           = top.tinymce.activeEditor.windowManager.getParams();
    win                = (args.window);
    input              = (args.input);
    dialog_type        = $('#visual_editor_dialog_type', window.parent.document).val();

    if (dialog_type == 'link') {
      selector = "#visual_editor_href";
    } else {
      selector = "#visual_editor_src";
    }
    win.document.getElementById(input).value = $(selector, window.parent.document).val();
    // window.alert( JSON.stringify(args) );
    top.tinymce.activeEditor.windowManager.close();
  });

});
